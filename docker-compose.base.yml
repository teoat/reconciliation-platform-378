# ============================================================================
# DOCKER COMPOSE BASE - Shared Service Definitions
# ============================================================================
# This file contains base service definitions that can be extended by other
# compose files. Use with: docker-compose -f docker-compose.base.yml -f <other>.yml
# ============================================================================
# Last Updated: January 2025
# Status: Base Configuration âœ…
# ============================================================================

x-postgres-base: &postgres-base
  image: postgres:15-alpine
  environment:
    POSTGRES_DB: ${POSTGRES_DB:-reconciliation_app}
    POSTGRES_USER: ${POSTGRES_USER:-postgres}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres_pass}
    POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
  volumes:
    - postgres_data:/var/lib/postgresql/data
  networks:
    - reconciliation-network
  restart: unless-stopped
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
    interval: 10s
    timeout: 5s
    retries: 5

x-redis-base: &redis-base
  image: redis:7-alpine
  volumes:
    - redis_data:/data
  networks:
    - reconciliation-network
  restart: unless-stopped
  environment:
    REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_pass}
  command:
    - sh
    - -c
    - "redis-server --requirepass \"$${REDIS_PASSWORD}\""
  healthcheck:
    test: ["CMD-SHELL", "redis-cli -a $${REDIS_PASSWORD} ping"]
    interval: 10s
    timeout: 3s
    retries: 5

x-backend-base: &backend-base
  build:
    context: .
    dockerfile: infrastructure/docker/Dockerfile.backend
  environment:
    DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres_pass}@postgres:5432/${POSTGRES_DB:-reconciliation_app}
    REDIS_URL: redis://:${REDIS_PASSWORD:-redis_pass}@redis:6379
    HOST: 0.0.0.0
    PORT: 2000
    BACKEND_PORT: 2000
    LOG_FORMAT: json
    JWT_SECRET: ${JWT_SECRET:-change-this-in-production}
    JWT_EXPIRATION: ${JWT_EXPIRATION:-86400}
    CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:1000}
    RUST_LOG: ${RUST_LOG:-info}
    MAX_FILE_SIZE: ${MAX_FILE_SIZE:-10485760}
    UPLOAD_PATH: /app/uploads
    DISABLE_AUTH: ${DISABLE_AUTH:-false}
  volumes:
    - uploads_data:/app/uploads
    - logs_data:/app/logs
  networks:
    - reconciliation-network
  depends_on:
    postgres:
      condition: service_healthy
    redis:
      condition: service_healthy
  restart: unless-stopped
  healthcheck:
    test: ["CMD-SHELL", "wget -q -O- http://localhost:2000/api/health >/dev/null 2>&1 || exit 1"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 40s

x-frontend-base: &frontend-base
  build:
    context: .
    dockerfile: infrastructure/docker/Dockerfile.frontend
    args:
      BUILDKIT_INLINE_CACHE: 1
      VITE_API_URL: ${VITE_API_URL:-http://localhost:2000}/api/v1
      VITE_WS_URL: ${VITE_WS_URL:-ws://localhost:2000}
  environment:
    - NODE_ENV=${NODE_ENV:-production}
    - DOCKER_BUILDKIT=1
  networks:
    - reconciliation-network
  depends_on:
    backend:
      condition: service_started
  restart: unless-stopped
  healthcheck:
    test: ["CMD-SHELL", "wget -q --spider http://localhost/health || exit 1"]
    interval: 30s
    timeout: 3s
    retries: 3
    start_period: 10s

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  reconciliation-network:
    driver: bridge

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  postgres_data:
  redis_data:
  uploads_data:
  logs_data:

