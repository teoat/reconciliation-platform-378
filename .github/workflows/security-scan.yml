name: Security Scanning

on:
  schedule:
    - cron: '0 3 * * *' # Daily at 3 AM
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        languages: javascript

    - name: Run Snyk security scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high

    - name: Run npm audit
      run: |
        npm audit --audit-level moderate
        npm audit --json > audit-results.json || true

    - name: Upload audit results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: audit-results
        path: audit-results.json
        retention-days: 30

    - name: Check for security vulnerabilities
      id: security-check
      run: |
        if [ -f audit-results.json ]; then
          VULN_COUNT=$(jq '.metadata.vulnerabilities.total // 0' audit-results.json)
          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "vulnerabilities=$VULN_COUNT" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
            exit 1
          fi
        fi
        echo "found=false" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Create Security Alert Issue
      if: steps.security-check.outputs.found == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let auditData = {};
          try {
            const auditContent = fs.readFileSync('audit-results.json', 'utf8');
            auditData = JSON.parse(auditContent);
          } catch (error) {
            console.log('Could not read audit results');
          }
          
          const vulnCount = auditData.metadata?.vulnerabilities?.total || 0;
          const critical = auditData.metadata?.vulnerabilities?.critical || 0;
          const high = auditData.metadata?.vulnerabilities?.high || 0;
          const moderate = auditData.metadata?.vulnerabilities?.moderate || 0;
          
          const title = `ðŸš¨ Security Alert: ${vulnCount} Vulnerabilities Detected`;
          const body = `## Security Vulnerability Alert
          
          **Alert Type**: Automated Security Scan
          **Date**: ${new Date().toISOString()}
          **Workflow**: ${{ github.workflow }}
          **Run ID**: ${{ github.run_id }}
          
          ### Vulnerability Summary
          - **Total**: ${vulnCount} vulnerabilities
          - **Critical**: ${critical}
          - **High**: ${high}
          - **Moderate**: ${moderate}
          
          ### Action Required
          1. Review the audit results in the workflow artifacts
          2. Run \`npm audit fix\` for automatic fixes where possible
          3. Manually address remaining vulnerabilities
          4. Verify fixes with \`npm audit\`
          
          ### Next Steps
          - Check the Security tab for detailed information
          - Review Dependabot PRs for dependency updates
          - Update vulnerable packages to secure versions
          
          ---
          *This alert was automatically generated by the security scanning workflow.*
          `;
          
          // Check if issue already exists
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'security-alert'
          });
          
          const existingIssue = issues.find(issue => issue.title.includes('Security Alert'));
          
          if (!existingIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'security-alert', 'automated']
            });
          } else {
            // Update existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `## Updated Security Alert\n\n${body}`
            });
          }

    - name: Send Security Alert Notification
      if: steps.security-check.outputs.found == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const vulnCount = '${{ steps.security-check.outputs.vulnerabilities }}' || 'unknown';
          console.log(`ðŸš¨ Security Alert: ${vulnCount} vulnerabilities detected`);
          console.log(`Please review the Security tab and update vulnerable dependencies.`);

