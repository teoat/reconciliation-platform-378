openapi: 3.0.3
info:
  title: Reconciliation Platform API
  description: |
    A comprehensive API for data reconciliation, matching, and analytics platform.
    This API provides endpoints for managing projects, data sources, reconciliation jobs,
    analytics, and real-time updates through WebSocket connections.
  version: 1.0.0
  contact:
    name: API Support
    email: support@reconciliation-platform.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080/api
    description: Development server
  - url: https://api.reconciliation-platform.com
    description: Production server

security:
  - bearerAuth: []

paths:
  # Authentication
  /auth/login:
    post:
      summary: User login
      description: Authenticate user and return access token
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: "password123"
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/register:
    post:
      summary: User registration
      description: Register a new user account
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - first_name
                - last_name
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
                  minLength: 8
                first_name:
                  type: string
                last_name:
                  type: string
                role:
                  type: string
                  enum: [admin, user, analyst, viewer]
                  default: user
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/me:
    get:
      summary: Get current user
      description: Get information about the currently authenticated user
      tags: [Authentication]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # Projects
  /projects:
    get:
      summary: List projects
      description: Get a paginated list of projects
      tags: [Projects]
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: search
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [active, inactive, archived, draft]
      responses:
        '200':
          description: Projects list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectListResponse'
    post:
      summary: Create project
      description: Create a new reconciliation project
      tags: [Projects]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProjectRequest'
      responses:
        '201':
          description: Project created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /projects/{id}:
    get:
      summary: Get project
      description: Get a specific project by ID
      tags: [Projects]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Project details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Update project
      description: Update an existing project
      tags: [Projects]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProjectRequest'
      responses:
        '200':
          description: Project updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: Delete project
      description: Delete a project
      tags: [Projects]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Project deleted
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # Data Sources
  /projects/{projectId}/data-sources:
    get:
      summary: List data sources
      description: Get data sources for a project
      tags: [Data Sources]
      security:
        - bearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Data sources list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DataSource'
    post:
      summary: Upload data source
      description: Upload a file as a data source
      tags: [Data Sources]
      security:
        - bearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: File to upload
                name:
                  type: string
                  description: Data source name
                source_type:
                  type: string
                  enum: [csv, excel, json, xml]
      responses:
        '201':
          description: File uploaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataSource'
        '400':
          description: Upload failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # Reconciliation
  /projects/{projectId}/reconciliation-jobs:
    get:
      summary: List reconciliation jobs
      description: Get reconciliation jobs for a project
      tags: [Reconciliation]
      security:
        - bearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, running, completed, failed, cancelled]
      responses:
        '200':
          description: Reconciliation jobs list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ReconciliationJob'
    post:
      summary: Create reconciliation job
      description: Create a new reconciliation job
      tags: [Reconciliation]
      security:
        - bearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateReconciliationJobRequest'
      responses:
        '201':
          description: Job created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReconciliationJob'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /projects/{projectId}/reconciliation-jobs/{jobId}/start:
    post:
      summary: Start reconciliation job
      description: Start a reconciliation job
      tags: [Reconciliation]
      security:
        - bearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReconciliationJob'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /projects/{projectId}/reconciliation-results:
    get:
      summary: Get reconciliation results
      description: Get reconciliation results for a project
      tags: [Reconciliation]
      security:
        - bearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: match_type
          in: query
          schema:
            type: string
            enum: [exact, fuzzy, manual, auto]
      responses:
        '200':
          description: Reconciliation results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReconciliationResultsResponse'

  # Analytics
  /analytics/dashboard:
    get:
      summary: Get dashboard analytics
      description: Get comprehensive dashboard analytics data
      tags: [Analytics]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Dashboard analytics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardData'

  /analytics/projects/{projectId}/stats:
    get:
      summary: Get project statistics
      description: Get detailed statistics for a specific project
      tags: [Analytics]
      security:
        - bearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Project statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectStats'

  # ML Matching
  /projects/{projectId}/ml-matching/find-matches:
    post:
      summary: Find matches using ML
      description: Use machine learning algorithms to find record matches
      tags: [ML Matching]
      security:
        - bearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - recordsA
                - recordsB
                - config
              properties:
                recordsA:
                  type: array
                  items:
                    $ref: '#/components/schemas/Record'
                recordsB:
                  type: array
                  items:
                    $ref: '#/components/schemas/Record'
                config:
                  $ref: '#/components/schemas/MatchingConfig'
      responses:
        '200':
          description: Match candidates found
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MatchCandidate'

  /ml/models:
    get:
      summary: List ML models
      description: Get available machine learning models
      tags: [ML Matching]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: ML models list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MLModel'

  # System
  /health:
    get:
      summary: Health check
      description: Check system health status
      tags: [System]
      responses:
        '200':
          description: System is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  timestamp:
                    type: string
                    format: date-time
                  version:
                    type: string

  /system/metrics:
    get:
      summary: System metrics
      description: Get system performance metrics
      tags: [System]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: System metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemMetrics'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # Common
    ID:
      type: string
      description: Unique identifier
      example: "550e8400-e29b-41d4-a716-446655440000"

    Timestamp:
      type: string
      format: date-time
      description: ISO 8601 timestamp
      example: "2024-01-15T10:30:00Z"

    # Authentication
    AuthResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT access token
        user:
          $ref: '#/components/schemas/User'
        expires_at:
          type: number
          description: Token expiration timestamp
          example: 1640995200

    User:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/ID'
        email:
          type: string
          format: email
        first_name:
          type: string
        last_name:
          type: string
        role:
          type: string
          enum: [admin, user, analyst, viewer]
        is_active:
          type: boolean
        last_login:
          $ref: '#/components/schemas/Timestamp'
        created_at:
          $ref: '#/components/schemas/Timestamp'
        updated_at:
          $ref: '#/components/schemas/Timestamp'

    # Projects
    Project:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/ID'
        name:
          type: string
        description:
          type: string
        owner_id:
          $ref: '#/components/schemas/ID'
        settings:
          type: object
        status:
          type: string
          enum: [active, inactive, archived, draft]
        is_active:
          type: boolean
        created_at:
          $ref: '#/components/schemas/Timestamp'
        updated_at:
          $ref: '#/components/schemas/Timestamp'

    CreateProjectRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        description:
          type: string
          maxLength: 500
        settings:
          type: object

    UpdateProjectRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        description:
          type: string
          maxLength: 500
        status:
          type: string
          enum: [active, inactive, archived, draft]
        settings:
          type: object

    ProjectListResponse:
      type: object
      properties:
        projects:
          type: array
          items:
            $ref: '#/components/schemas/Project'
        total:
          type: integer
        page:
          type: integer
        per_page:
          type: integer

    # Data Sources
    DataSource:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/ID'
        project_id:
          $ref: '#/components/schemas/ID'
        name:
          type: string
        source_type:
          type: string
          enum: [csv, excel, json, xml]
        file_path:
          type: string
        file_size:
          type: integer
        status:
          type: string
          enum: [uploaded, processing, processed, failed]
        created_at:
          $ref: '#/components/schemas/Timestamp'
        updated_at:
          $ref: '#/components/schemas/Timestamp'

    # Reconciliation
    ReconciliationJob:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/ID'
        project_id:
          $ref: '#/components/schemas/ID'
        name:
          type: string
        description:
          type: string
        source_a_id:
          $ref: '#/components/schemas/ID'
        source_b_id:
          $ref: '#/components/schemas/ID'
        confidence_threshold:
          type: number
          minimum: 0
          maximum: 1
        matching_rules:
          type: array
          items:
            $ref: '#/components/schemas/MatchingRule'
        status:
          type: string
          enum: [pending, running, completed, failed, cancelled]
        progress:
          type: number
          minimum: 0
          maximum: 100
        total_records:
          type: integer
        processed_records:
          type: integer
        matched_records:
          type: integer
        unmatched_records:
          type: integer
        created_by:
          $ref: '#/components/schemas/ID'
        started_at:
          $ref: '#/components/schemas/Timestamp'
        completed_at:
          $ref: '#/components/schemas/Timestamp'
        created_at:
          $ref: '#/components/schemas/Timestamp'
        updated_at:
          $ref: '#/components/schemas/Timestamp'

    MatchingRule:
      type: object
      properties:
        field_a:
          type: string
        field_b:
          type: string
        rule_type:
          type: string
          enum: [Exact, Fuzzy, Contains, StartsWith, EndsWith, NumericRange, DateRange]
        weight:
          type: number
          minimum: 0
          maximum: 1
        exact_match:
          type: boolean

    CreateReconciliationJobRequest:
      type: object
      required:
        - source_a_id
        - source_b_id
      properties:
        name:
          type: string
        description:
          type: string
        source_a_id:
          $ref: '#/components/schemas/ID'
        source_b_id:
          $ref: '#/components/schemas/ID'
        confidence_threshold:
          type: number
          minimum: 0
          maximum: 1
          default: 0.8
        matching_rules:
          type: array
          items:
            $ref: '#/components/schemas/MatchingRule'

    ReconciliationResult:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/ID'
        job_id:
          $ref: '#/components/schemas/ID'
        source_a_id:
          $ref: '#/components/schemas/ID'
        source_b_id:
          $ref: '#/components/schemas/ID'
        record_a_id:
          type: string
        record_b_id:
          type: string
        match_type:
          type: string
          enum: [exact, fuzzy, manual, auto]
        confidence_score:
          type: number
          minimum: 0
          maximum: 1
        match_details:
          type: object
        created_at:
          $ref: '#/components/schemas/Timestamp'

    ReconciliationResultsResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/ReconciliationResult'
        total:
          type: integer
        page:
          type: integer
        per_page:
          type: integer

    # ML Matching
    Record:
      type: object
      properties:
        id:
          type: string
        data:
          type: object
          description: Record data as key-value pairs

    MatchingConfig:
      type: object
      required:
        - threshold
        - features
      properties:
        threshold:
          type: number
          minimum: 0
          maximum: 1
          default: 0.8
        algorithms:
          type: array
          items:
            type: string
          default: ["cosine", "levenshtein"]
        weights:
          type: object
          additionalProperties:
            type: number
        features:
          type: array
          items:
            type: string
          enum: [amount, date, description, category, reference]

    MatchCandidate:
      type: object
      properties:
        recordA:
          $ref: '#/components/schemas/Record'
        recordB:
          $ref: '#/components/schemas/Record'
        confidence:
          type: number
          minimum: 0
          maximum: 1
        matchType:
          type: string
          enum: [exact, fuzzy, ml_predicted]
        features:
          type: object
          additionalProperties:
            type: number
        explanation:
          type: string

    MLModel:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        type:
          type: string
          enum: [similarity, classification, clustering]
        algorithm:
          type: string
        version:
          type: string
        trained:
          type: boolean
        accuracy:
          type: number
          minimum: 0
          maximum: 1
        features:
          type: array
          items:
            type: string

    # Analytics
    DashboardData:
      type: object
      properties:
        total_users:
          type: integer
        total_projects:
          type: integer
        total_files:
          type: integer
        total_reconciliation_jobs:
          type: integer
        active_jobs:
          type: integer
        completed_jobs:
          type: integer
        failed_jobs:
          type: integer
        total_matches:
          type: integer
        total_unmatched:
          type: integer
        performance_metrics:
          $ref: '#/components/schemas/PerformanceMetrics'
        recent_activity:
          type: array
          items:
            $ref: '#/components/schemas/ActivityItem'

    PerformanceMetrics:
      type: object
      properties:
        average_processing_time_ms:
          type: number
        total_processing_time_ms:
          type: number
        average_confidence_score:
          type: number
        match_rate:
          type: number
        throughput_per_hour:
          type: number

    ActivityItem:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/ID'
        action:
          type: string
        resource_type:
          type: string
        user_email:
          type: string
        timestamp:
          $ref: '#/components/schemas/Timestamp'
        details:
          type: object

    ProjectStats:
      type: object
      properties:
        project_id:
          $ref: '#/components/schemas/ID'
        project_name:
          type: string
        total_jobs:
          type: integer
        completed_jobs:
          type: integer
        failed_jobs:
          type: integer
        total_records:
          type: integer
        matched_records:
          type: integer
        unmatched_records:
          type: integer
        average_confidence:
          type: number
        last_activity:
          $ref: '#/components/schemas/Timestamp'

    # System
    SystemMetrics:
      type: object
      properties:
        cpu_usage:
          type: number
          minimum: 0
          maximum: 100
        memory_usage:
          type: number
          minimum: 0
          maximum: 100
        disk_usage:
          type: number
          minimum: 0
          maximum: 100
        active_connections:
          type: integer
        uptime_seconds:
          type: integer
        response_time_ms:
          type: number

    # Error
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        code:
          type: string
        timestamp:
          $ref: '#/components/schemas/Timestamp'
        path:
          type: string
        method:
          type: string

  # WebSocket Events
  messages:
    JobProgress:
      summary: Job progress update
      payload:
        type: object
        properties:
          job_id:
            type: string
          progress:
            type: number
          status:
            type: string
          message:
            type: string
    JobCompleted:
      summary: Job completion notification
      payload:
        type: object
        properties:
          job_id:
            type: string
          status:
            type: string
          results:
            type: object
          completed_at:
            type: string
            format: date-time
    UserPresence:
      summary: User presence update
      payload:
        type: object
        properties:
          user_id:
            type: string
          action:
            type: string
            enum: [join, leave, update]
          timestamp:
            type: string
            format: date-time