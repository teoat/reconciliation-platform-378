const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const CODE_SPLITTING_REPORT_PATH = path.join(__dirname, '../code-splitting-report.json');
const WEBPACK_STATS_PATH = path.join(__dirname, '../bundle-analysis/stats.json'); // Assuming Next.js build output

async function analyzeCodeSplitting() {
    console.log("Starting code splitting analysis...");

    // Ensure a build has been run to generate webpack stats
    if (!fs.existsSync(WEBPACK_STATS_PATH)) {
        console.log("Webpack stats not found. Running 'npm run build' to generate them...");
        try {
            execSync('npm run build', { stdio: 'inherit' });
            console.log("Build completed successfully.");
        } catch (error) {
            console.error("Error during build process:", error.message);
            console.error("Code splitting analysis aborted.");
            return;
        }
    }

    if (!fs.existsSync(WEBPACK_STATS_PATH)) {
        console.error(`Error: Webpack stats file not found at ${WEBPACK_STATS_PATH} after build.`);
        console.error("Code splitting analysis aborted.");
        return;
    }

    try {
        // Run webpack-bundle-analyzer to generate a JSON report
        // We need to ensure webpack-bundle-analyzer is configured to output JSON
        // For Next.js, this usually involves a custom next.config.js setup.
        // For simplicity, we'll try to parse the stats directly if possible,
        // or instruct the user to configure webpack-bundle-analyzer for JSON output.

        const stats = JSON.parse(fs.readFileSync(WEBPACK_STATS_PATH, 'utf-8'));

        // Basic parsing of webpack stats for code splitting report
        let totalSizeKB = 0;
        let criticalFiles = 0;
        const files = [];

        if (stats.assets) {
            stats.assets.forEach(asset => {
                if (asset.name.endsWith('.js') || asset.name.endsWith('.css')) {
                    const sizeKB = Math.round(asset.size / 1024);
                    totalSizeKB += sizeKB;
                    files.push({ name: asset.name, sizeKB: sizeKB, type: asset.chunkNames.length > 0 ? 'chunk' : 'asset' });

                    // Simple heuristic for critical files (e.g., main entry points)
                    if (asset.name.startsWith('main') || asset.name.startsWith('app')) {
                        criticalFiles++;
                    }
                }
            });
        }

        const report = {
            timestamp: new Date().toISOString(),
            summary: {
                totalFiles: files.length,
                totalSizeKB: totalSizeKB,
                criticalFiles: criticalFiles,
                potentialSavingsKB: Math.round(totalSizeKB * 0.2), // Placeholder for potential savings
            },
            files: files,
            details: "Code splitting data generated by scripts/analyze-code-splitting.js using webpack stats."
        };

        fs.writeFileSync(CODE_SPLITTING_REPORT_PATH, JSON.stringify(report, null, 2));
        console.log(`âœ… Code splitting report generated: ${CODE_SPLITTING_REPORT_PATH}`);

    } catch (error) {
        console.error("Error during code splitting analysis:", error.message);
        console.error("Please ensure 'webpack-bundle-analyzer' is configured to output a stats.json file, or that the build process generates one.");
        // Fallback to placeholder if real analysis fails
        const placeholderReport = {
            timestamp: new Date().toISOString(),
            summary: {
                totalFiles: 0,
                totalSizeKB: 0,
                criticalFiles: 0,
                potentialSavingsKB: 0,
            },
            files: [],
            details: "Code splitting analysis failed, generated placeholder data."
        };
        fs.writeFileSync(CODE_SPLITTING_REPORT_PATH, JSON.stringify(placeholderReport, null, 2));
    }
}

// Check for --analyze argument
const args = process.argv.slice(2);
if (args.includes('--analyze')) {
    analyzeCodeSplitting();
} else {
    console.log("Usage: node scripts/analyze-code-splitting.js --analyze");
}