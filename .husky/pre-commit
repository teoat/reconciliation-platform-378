#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ============================================================================
# Pre-commit Hook - Code Quality Checks
# ============================================================================
# This hook runs before every commit to ensure code quality:
# 1. Linting and formatting (via lint-staged)
# 2. Type checking
# 3. Build verification
# 4. Security audit
# 5. Tests (in CI only)
# ============================================================================

set -e

echo "üîç Running pre-commit checks..."

# 1. Run lint-staged (linting, formatting on staged files)
echo "üìù Running lint-staged (linting & formatting)..."
npx lint-staged || {
  echo "‚ùå lint-staged failed. Please fix the issues above."
  exit 1
}

# 2. Run type checking (fail on error)
echo "üî∑ Running TypeScript type check..."
if [ -f "frontend/package.json" ]; then
  cd frontend
  npm run type-check 2>/dev/null || npx tsc --noEmit || {
    echo "‚ùå TypeScript type check failed. Please fix type errors."
    exit 1
  }
  cd ..
elif [ -f "package.json" ]; then
  npx tsc --noEmit || {
    echo "‚ùå TypeScript type check failed. Please fix type errors."
    exit 1
  }
fi

# 3. Run Rust type checking (if backend exists)
if [ -f "backend/Cargo.toml" ]; then
  echo "ü¶Ä Running Rust type check..."
  cd backend
  cargo check --message-format=short 2>&1 | head -20 || {
    echo "‚ö†Ô∏è Rust type check found issues (non-blocking)"
  }
  cd ..
fi

# 4. Run build verification (fail on error in CI, warn in local)
echo "üèóÔ∏è Running build verification..."
if [ -n "$CI" ]; then
  if [ -f "frontend/package.json" ]; then
    cd frontend && npm run build || exit 1 && cd ..
  else
    npm run build || exit 1
  fi
else
  if [ -f "frontend/package.json" ]; then
    cd frontend && npm run build || echo "‚ö†Ô∏è Build failed, please fix before committing" && cd ..
  else
    npm run build || echo "‚ö†Ô∏è Build failed, please fix before committing"
  fi
fi

# 5. Run security audit (warn only, don't block)
echo "üîí Running security audit..."
if [ -f "frontend/package.json" ]; then
  cd frontend
  npm audit --audit-level moderate || echo "‚ö†Ô∏è Security vulnerabilities found, please review"
  cd ..
else
  npm audit --audit-level moderate || echo "‚ö†Ô∏è Security vulnerabilities found, please review"
fi

# 6. Run tests (fail on error in CI, warn in local)
if [ -n "$CI" ]; then
  echo "üß™ Running tests (CI mode)..."
  if [ -f "frontend/package.json" ]; then
    cd frontend && npm run test:ci || exit 1 && cd ..
  else
    npm run test:ci || exit 1
  fi
else
  echo "üß™ Running tests (local mode, non-blocking)..."
  if [ -f "frontend/package.json" ]; then
    cd frontend && npm run test || echo "‚ö†Ô∏è Tests failed, please fix before committing" && cd ..
  else
    npm run test || echo "‚ö†Ô∏è Tests failed, please fix before committing"
  fi
fi

# 7. Run technical debt check (warn only)
if [ -f "package.json" ] && npm run audit:debt >/dev/null 2>&1; then
  echo "üìä Running technical debt audit..."
  npm run audit:debt || echo "‚ö†Ô∏è Technical debt audit failed, continuing..."
fi

# 8. Run dependency validation (fail on circular deps, warn on other violations)
echo "üîó Running dependency validation..."
if [ -f "package.json" ] && npm run deps:validate >/dev/null 2>&1; then
  npm run deps:validate || {
    echo "‚ö†Ô∏è Dependency validation found issues (non-blocking in local)"
    if [ -n "$CI" ]; then
      echo "‚ùå Dependency validation failed in CI. Fix issues before merging."
      exit 1
    fi
  }
fi

echo "‚úÖ Pre-commit checks passed!"

